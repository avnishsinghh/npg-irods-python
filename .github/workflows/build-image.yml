name: Build and push Docker image

on:
  release:
    types: [published]

jobs:
  build_image:
    runs-on: ubuntu-latest

    name: Build Docker image
    env:
      IMAGE_NAME: npg-irods-python
      REPOSITORY_OWNER: ${{ github.repository_owner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Force fetch annotated tags (workaround)
        # Workaround for https://github.com/actions/checkout/issues/290
        run: |
            git fetch --force --tags

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          install: true

      - name: Login to Docker registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Capture git parameters
        shell: bash
        run: |
          echo 'GIT_TAG='$(git describe --always) >> $GITHUB_ENV
          echo 'GIT_URL='$(git remote get-url origin) >> $GITHUB_ENV
          echo 'GIT_COMMIT='$(git log --pretty=format:'%H' -n 1) >> $GITHUB_ENV

      - name: Build image
        run: |
          docker build \
           --file Dockerfile \
           --platform linux/amd64 \
           --progress plain \
           --load \
           --label "uk.ac.sanger.repository=$GIT_URL" \
           --label "uk.ac.sanger.commit=$GIT_COMMIT" \
           --tag "ghcr.io/$REPOSITORY_OWNER/$IMAGE_NAME:latest" \
           --tag "ghcr.io/$REPOSITORY_OWNER/$IMAGE_NAME:$GIT_TAG" \
           .

      - name: Push image
        run: |
          docker images
          docker push "ghcr.io/$REPOSITORY_OWNER/$IMAGE_NAME:$GIT_TAG"
          docker push "ghcr.io/$REPOSITORY_OWNER/$IMAGE_NAME:latest"
